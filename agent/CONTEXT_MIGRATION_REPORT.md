# HTTP Context Migration Report

## Inventory of Legacy Usage
The following legacy mechanisms were identified and targeted for removal:
*   `App\Context\HttpContextProvider`
*   `App\Context\ContextProviderInterface`
*   `App\Context\Resolver\AdminContextResolver`
*   `App\Context\Resolver\RequestContextResolver`
*   `App\Http\Middleware\ContextProviderMiddleware`
*   Usage of `$container->get(ServerRequestInterface::class)` for context bridging.

## Files Replaced/Modified
*   `app/Http/Middleware/SessionGuardMiddleware.php`: Removed container dependency and request injection.
*   `app/Bootstrap/Container.php`: Removed legacy bindings.
*   `app/Http/Controllers/AuthController.php`: Migrated to use Request Attributes.
*   `app/Http/Controllers/Web/LoginController.php`: Migrated to use Request Attributes.
*   `routes/web.php`: Updated middleware stack (Removed `ContextProviderMiddleware`, added `RequestContextMiddleware` and `AdminContextMiddleware`).
*   `app/Context/AdminContext.php`: Cleaned up to be a value object.

## Files Deleted
*   `app/Context/HttpContextProvider.php`
*   `app/Context/ContextProviderInterface.php`
*   `app/Context/Resolver/AdminContextResolver.php`
*   `app/Context/Resolver/RequestContextResolver.php`
*   `app/Http/Middleware/ContextProviderMiddleware.php`
*   `app/Services/ActivityLog/AdminActivityLogService.php`: **DELETED** as it was an unused duplicate of `App\Domain\ActivityLog\Service\AdminActivityLogService`. The Domain service provides the exact same contract and is the one actually used by the application (verified via grep and Container definitions).

## Middleware Order Decisions
Slim executes middleware in LIFO order (Last Added, First Executed).

1.  **RequestIdMiddleware**: Added **LAST**, so it executes **FIRST**. This generates the UUID.
2.  **RequestContextMiddleware**: Added **SECOND TO LAST**, so it executes **SECOND**. It reads the UUID generated by `RequestIdMiddleware`.
3.  **AdminContextMiddleware**: Added **AFTER** `SessionGuardMiddleware` in the route group configuration.
    *   In code: `$group->add(AdminContextMiddleware::class)->add(SessionGuardMiddleware::class)`.
    *   Execution: `SessionGuardMiddleware` runs (authenticates, sets `admin_id` attribute) -> `AdminContextMiddleware` runs (reads `admin_id`, sets `AdminContext`).

## Test Coverage
*   `tests/Http/Middleware/RequestContextMiddlewareTest.php`: Verifies success path and hard-fail on missing `request_id`.
*   `tests/Http/Middleware/AdminContextMiddlewareTest.php`: Verifies `AdminContext` creation when `admin_id` is present/absent.
*   `tests/Http/Controllers/AuthControllerTest.php`: Verifies `login` logic uses `AdminContext` (constructed manually) and `RequestContext` (from attribute) for logging.

## Final Grep Confirmation
A final grep for `HttpContextProvider`, `ContextProviderInterface`, `Resolver`, and `ContextProviderMiddleware` returned ZERO hits.
