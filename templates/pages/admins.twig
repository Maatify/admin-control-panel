{% extends "layouts/base.twig" %}

{% block title %}Admins{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Admins</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="/admins/create" class="btn btn-sm btn-outline-primary">
            Create New
        </a>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-sm" id="admins-table">
        <thead>
            <tr>
                <th scope="col">ID</th>
                <th scope="col">Identifier</th>
                <th scope="col">Status</th>
                <th scope="col">Roles</th>
                <th scope="col">Created At</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="6" class="text-center">Loading...</td></tr>
        </tbody>
    </table>
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center" id="pagination">
            <!-- JS Paging -->
        </ul>
    </nav>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    loadAdmins(1);
});

async function loadAdmins(page) {
    try {
        const response = await fetch('/api/admins/query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ page: page, per_page: 20 })
        });

        if (!response.ok) {
            if (response.status === 401) window.location.href = '/login';
            throw new Error('Failed to load');
        }

        const json = await response.json();
        renderTable(json.data);
        renderPagination(json.pagination);
    } catch (e) {
        console.error(e);
        document.querySelector('#admins-table tbody').innerHTML = '<tr><td colspan="6" class="text-danger">Error loading data</td></tr>';
    }
}

function renderTable(data) {
    const tbody = document.querySelector('#admins-table tbody');
    tbody.innerHTML = '';

    data.forEach(admin => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${admin.id}</td>
            <td>${escapeHtml(admin.identifier)}</td>
            <td>${admin.verification_status}</td>
            <td>${admin.roles.join(', ')}</td>
            <td>${admin.created_at}</td>
            <td>
                <a href="/admins/${admin.id}/edit" class="btn btn-sm btn-outline-secondary">Edit</a>
                <button onclick="disableAdmin(${admin.id})" class="btn btn-sm btn-outline-danger">Disable</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function renderPagination(meta) {
    // Simplified pagination
    const nav = document.getElementById('pagination');
    nav.innerHTML = '';

    if (meta.page > 1) {
        nav.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadAdmins(${meta.page - 1})">Previous</a></li>`;
    }
    nav.innerHTML += `<li class="page-item disabled"><span class="page-link">Page ${meta.page} of ${Math.ceil(meta.total / meta.per_page)}</span></li>`;
    if (meta.page * meta.per_page < meta.total) {
        nav.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadAdmins(${meta.page + 1})">Next</a></li>`;
    }
}

async function disableAdmin(id) {
    if (!confirm('Are you sure you want to disable this admin? This will revoke all sessions.')) return;

    try {
        const response = await fetch(`/api/admins/${id}/disable`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
            loadAdmins(1); // Refresh
        } else {
            alert('Failed to disable');
        }
    } catch (e) {
        console.error(e);
    }
}

function escapeHtml(text) {
  return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
}
</script>
{% endblock %}
